<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Video Audio Text Service</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <!-- Custom CSS for markdown rendering -->
    <style>
        .markdown-content {
            line-height: 1.6;
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            font-weight: 600;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content h1 { font-size: 1.25rem; }
        .markdown-content h2 { font-size: 1.125rem; }
        .markdown-content h3 { font-size: 1rem; }
        .markdown-content p {
            margin-bottom: 0.75rem;
        }
        .markdown-content ul, .markdown-content ol {
            margin-bottom: 0.75rem;
            padding-left: 1.5rem;
        }
        .markdown-content ul li {
            list-style-type: disc;
            margin-bottom: 0.25rem;
        }
        .markdown-content ol li {
            list-style-type: decimal;
            margin-bottom: 0.25rem;
        }
        .markdown-content code {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        .markdown-content pre {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 0.75rem;
            border-radius: 0.375rem;
            overflow-x: auto;
            margin-bottom: 0.75rem;
        }
        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin: 0.75rem 0;
            font-style: italic;
        }
        .markdown-content strong {
            font-weight: 600;
        }
        .markdown-content em {
            font-style: italic;
        }
        
        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 16px;
            border-left: 4px solid;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success {
            border-left-color: #10b981;
        }
        
        .toast.error {
            border-left-color: #ef4444;
        }
        
        .toast.info {
            border-left-color: #3b82f6;
        }
        
        .toast.warning {
            border-left-color: #f59e0b;
        }
        
        .toast-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 12px;
            font-size: 12px;
        }
        
        .toast.success .toast-icon {
            background-color: #d1fae5;
            color: #059669;
        }
        
        .toast.error .toast-icon {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .toast.info .toast-icon {
            background-color: #dbeafe;
            color: #2563eb;
        }
        
        .toast.warning .toast-icon {
            background-color: #fef3c7;
            color: #d97706;
        }
        
        .toast-content {
            display: flex;
            align-items: flex-start;
        }
        
        .toast-message {
            flex: 1;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .toast-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .toast-description {
            color: #6b7280;
        }
        
        .toast-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }
        
        .toast-close:hover {
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <nav class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-video text-2xl text-blue-600"></i>
                    <h1 class="text-xl font-bold text-gray-800">Video Audio Text Service</h1>
                </div>
                <div class="flex items-center space-x-4">
                    {% if user.picture %}
                        <img src="{{ user.picture }}" alt="Profile" class="w-8 h-8 rounded-full">
                    {% endif %}
                    <span class="text-gray-700">{{ user.name }}</span>
                    <a href="/profile" class="text-purple-600 hover:text-purple-800">
                        <i class="fas fa-user-cog mr-1"></i>Profile
                    </a>
                    <a href="/" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-home mr-1"></i>Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Upload Section -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">
                <i class="fas fa-cloud-upload-alt text-blue-600 mr-2"></i>Process Media
            </h2>
            
            <!-- Tab Navigation -->
            <div class="flex space-x-4 mb-6 border-b border-gray-200">
                <button id="youtube-tab" onclick="switchTab('youtube')" class="pb-2 px-1 text-red-600 border-b-2 border-red-600 font-medium">
                    <i class="fab fa-youtube mr-1"></i>YouTube
                </button>
                <button id="video-tab" onclick="switchTab('video')" class="pb-2 px-1 text-gray-500 hover:text-gray-700 font-medium">
                    <i class="fas fa-file-video mr-1"></i>Upload Video
                </button>
                <button id="audio-tab" onclick="switchTab('audio')" class="pb-2 px-1 text-gray-500 hover:text-gray-700 font-medium">
                    <i class="fas fa-file-audio mr-1"></i>Upload Audio
                </button>
            </div>
            
            <!-- YouTube URL Tab (Default) -->
            <div id="youtube-url-section">
                <div class="space-y-4">
                    <div>
                        <label for="youtube-url" class="block text-sm font-medium text-gray-700 mb-2">
                            YouTube URL or Video ID
                        </label>
                        <div class="flex space-x-3">
                            <input type="text" id="youtube-url" placeholder="https://www.youtube.com/watch?v=wP3uQUZlhdo or wP3uQUZlhdo" 
                                   class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <button onclick="processYouTubeURL()" id="youtube-submit-btn"
                                    class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors flex items-center">
                                <i class="fab fa-youtube mr-2"></i>Process
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Supports full YouTube URLs, YouTube Shorts, or just the video ID (11 characters)
                        </p>
                    </div>
                    
                    <div>
                        <label for="youtube-summary-prompt" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-brain mr-1 text-purple-600"></i>Custom Summary Prompt (Optional)
                        </label>
                        <textarea id="youtube-summary-prompt" 
                                  placeholder="Enter a custom prompt to guide the AI summary. For example: 'Focus on the key technical concepts and practical applications mentioned in this video.' Leave blank for default summary."
                                  rows="3"
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-vertical"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-lightbulb mr-1"></i>Tip: Be specific about what aspects you want the summary to focus on
                        </p>
                    </div>
                    
                    <div id="youtube-progress" class="hidden">
                        <div class="bg-red-50 rounded-lg p-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm font-medium text-red-700">
                                    <i class="fas fa-download mr-1"></i>Downloading from YouTube...
                                </span>
                                <span class="text-sm text-red-600">Please wait</span>
                            </div>
                            <div class="w-full bg-red-200 rounded-full h-2">
                                <div class="bg-red-600 h-2 rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Video Upload Tab -->
            <div id="video-upload-section" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label for="video-file" class="block text-sm font-medium text-gray-700 mb-2">
                            Video File
                        </label>
                        <div id="video-upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                            <i class="fas fa-file-video text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">Click to select or drag and drop your video file</p>
                            <p class="text-sm text-gray-500">Supports MP4, MOV, AVI, MKV, WebM and more</p>
                            <input type="file" id="video-file" accept="video/*" class="hidden">
                        </div>
                    </div>
                    
                    <div>
                        <label for="video-summary-prompt" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-brain mr-1 text-purple-600"></i>Custom Summary Prompt (Optional)
                        </label>
                        <textarea id="video-summary-prompt" 
                                  placeholder="Enter a custom prompt to guide the AI summary. For example: 'Summarize the main points and actionable insights from this video.' Leave blank for default summary."
                                  rows="3"
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-vertical"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-lightbulb mr-1"></i>Tip: Be specific about what aspects you want the summary to focus on
                        </p>
                    </div>
                </div>
                
                <div id="video-upload-progress" class="hidden mt-4">
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-blue-700">Uploading video...</span>
                            <span id="video-progress-text" class="text-sm text-blue-600">0%</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div id="video-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio Upload Tab -->
            <div id="audio-upload-section" class="hidden">
                <div class="space-y-4">
                    <div>
                        <label for="audio-file" class="block text-sm font-medium text-gray-700 mb-2">
                            Audio File
                        </label>
                        <div id="audio-upload-area" class="border-2 border-dashed border-green-300 rounded-lg p-8 text-center hover:border-green-400 transition-colors cursor-pointer">
                            <i class="fas fa-file-audio text-4xl text-green-400 mb-4"></i>
                            <p class="text-gray-600 mb-2">Click to select or drag and drop your audio file</p>
                            <p class="text-sm text-gray-500">Supports MP3, WAV, M4A, FLAC, OGG and more</p>
                            <input type="file" id="audio-file" accept="audio/*" class="hidden">
                        </div>
                    </div>
                    
                    <div>
                        <label for="audio-summary-prompt" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-brain mr-1 text-purple-600"></i>Custom Summary Prompt (Optional)
                        </label>
                        <textarea id="audio-summary-prompt" 
                                  placeholder="Enter a custom prompt to guide the AI summary. For example: 'Summarize the key points and main topics discussed in this audio.' Leave blank for default summary."
                                  rows="3"
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-vertical"></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-lightbulb mr-1"></i>Tip: Be specific about what aspects you want the summary to focus on
                        </p>
                    </div>
                </div>
                
                <div id="audio-upload-progress" class="hidden mt-4">
                    <div class="bg-green-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-green-700">Uploading audio...</span>
                            <span id="audio-progress-text" class="text-sm text-green-600">0%</span>
                        </div>
                        <div class="w-full bg-green-200 rounded-full h-2">
                            <div id="audio-progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Jobs Section -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-800">
                        <i class="fas fa-tasks text-green-600 mr-2"></i>Your Jobs
                    </h2>
                    <button onclick="refreshJobs()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <div id="jobs-container" class="p-6">
                {% if jobs %}
                    <div class="space-y-4">
                        {% for job in jobs %}
                        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex-1 mr-4">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <h3 class="font-semibold text-gray-800">{{ job.filename }}</h3>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium
                                            {% if job.status == 'completed' %}bg-green-100 text-green-800
                                            {% elif job.status == 'processing' %}bg-blue-100 text-blue-800
                                            {% elif job.status == 'failed' %}bg-red-100 text-red-800
                                            {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                            {% if job.status == 'completed' %}<i class="fas fa-check-circle mr-1"></i>
                                            {% elif job.status == 'processing' %}<i class="fas fa-spinner fa-spin mr-1"></i>
                                            {% elif job.status == 'failed' %}<i class="fas fa-exclamation-circle mr-1"></i>
                                            {% else %}<i class="fas fa-clock mr-1"></i>{% endif %}
                                            {{ job.status.title() }}
                                        </span>
                                        {% if job.status == 'completed' and job.summary %}
                                        <button onclick="showEditPromptModal(this)" 
                                                data-job-id="{{ job.id }}"
                                                data-current-prompt="{{ job.summary_prompt or '' }}"
                                                class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700 transition-colors">
                                            <i class="fas fa-edit mr-1"></i>Edit Prompt
                                        </button>
                                        {% endif %}
                                    </div>
                                    <p class="text-sm text-gray-600">
                                        Created: {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                        {% if job.completed_at %}
                                        | Completed: {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                        {% endif %}
                                    </p>
                                    {% if job.error_message %}
                                    <p class="text-sm text-red-600 mt-1">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>{{ job.error_message }}
                                    </p>
                                    {% endif %}
                                    
                                    <!-- Summary display inline -->
                                    {% if job.status == 'completed' and job.summary %}
                                    <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <h4 id="content-header-{{ job.id }}" class="text-sm font-semibold text-blue-800 mb-2">
                                            <i class="fas fa-brain mr-1"></i>AI Summary
                                            {% if job.summary_prompt %}
                                            <span class="text-xs font-normal text-purple-600 ml-2">
                                                <i class="fas fa-magic mr-1"></i>Custom Prompt
                                            </span>
                                            {% endif %}
                                        </h4>
                                        {% if job.summary_prompt %}
                                        <div class="mb-2 p-2 bg-purple-50 rounded border border-purple-200">
                                            <p class="text-xs text-purple-700 font-medium mb-1">
                                                <i class="fas fa-quote-left mr-1"></i>Custom Prompt Used:
                                            </p>
                                            <p class="text-xs text-purple-600 italic">"{{ job.summary_prompt }}"</p>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Content area that can switch between summary text and audio player -->
                                        <div id="content-{{ job.id }}" class="w-full max-w-none">
                                            <div class="text-sm text-blue-700 leading-relaxed markdown-content">
                                                {{ job.summary | markdown | safe }}
                                            </div>
                                        </div>
                                        
                                        <!-- Audio player template (hidden by default) -->
                                        <div id="audio-player-{{ job.id }}" class="hidden w-full">
                                            <div class="bg-white rounded-lg p-4 border border-gray-200 w-full">
                                                <div class="flex items-center justify-between mb-3">
                                                    <h5 id="audio-title-{{ job.id }}" class="font-medium text-gray-800">Audio Player</h5>
                                                    <button onclick="showSummaryText('{{ job.id }}')" class="text-gray-500 hover:text-gray-700 text-sm">
                                                        <i class="fas fa-times mr-1"></i>Close Player
                                                    </button>
                                                </div>
                                                
                                                <audio id="audio-element-{{ job.id }}" controls class="w-full mb-3" controlsList="nodownload">
                                                    <source id="audio-source-{{ job.id }}" src="" type="audio/mpeg">
                                                    Your browser does not support the audio element.
                                                </audio>
                                                
                                                <!-- Progress Info -->
                                                <div class="text-xs text-gray-600 mb-3">
                                                    <div class="flex justify-between">
                                                        <span id="current-time-{{ job.id }}">00:00</span>
                                                        <span id="duration-{{ job.id }}">00:00</span>
                                                    </div>
                                                    <div class="mt-1">
                                                        <span id="resume-info-{{ job.id }}"></span>
                                                    </div>
                                                </div>
                                                
                                                <!-- Speed Control -->
                                                <div class="flex items-center justify-center space-x-2">
                                                    <label for="speed-control-{{ job.id }}" class="text-xs text-gray-600">Speed:</label>
                                                    <select id="speed-control-{{ job.id }}" onchange="changeSpeed('{{ job.id }}')" class="border border-gray-300 rounded px-2 py-1 text-xs">
                                                        <option value="0.5">0.5x</option>
                                                        <option value="0.75">0.75x</option>
                                                        <option value="1" selected>1x</option>
                                                        <option value="1.25">1.25x</option>
                                                        <option value="1.5">1.5x</option>
                                                        <option value="2">2x</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="flex items-start space-x-2 flex-shrink-0">
                                    {% if job.status == 'completed' %}
                                        <!-- Smart Default Action Button -->
                                        <div class="relative">
                                            {% if job.summary_speech_file %}
                                            <div class="flex">
                                                <button onclick="performDefaultAction('{{ job.id }}', '{{ job.summary_speech_file }}', 'Summary')" 
                                                        id="default-btn-{{ job.id }}"
                                                        class="bg-indigo-600 text-white px-3 py-2 rounded-l text-sm hover:bg-indigo-700 transition-colors flex items-center">
                                                    <i class="fas fa-play mr-1"></i><span id="btn-text-{{ job.id }}">Summary</span>
                                                </button>
                                                <button onclick="toggleJobActions('{{ job.id }}')" 
                                                        class="bg-indigo-600 text-white px-2 py-2 rounded-r text-sm hover:bg-indigo-700 transition-colors border-l border-indigo-500">
                                                    <i class="fas fa-chevron-down"></i>
                                                </button>
                                            </div>
                                            {% else %}
                                            <button onclick="toggleJobActions('{{ job.id }}')" 
                                                    id="default-btn-{{ job.id }}"
                                                    class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition-colors flex items-center">
                                                <i class="fas fa-cog mr-1"></i><span id="btn-text-{{ job.id }}">Actions</span>
                                                <i class="fas fa-chevron-down ml-1"></i>
                                            </button>
                                            {% endif %}
                                            
                                            <!-- Dropdown Menu -->
                                            <div id="actions-{{ job.id }}" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 z-10">
                                                <div class="py-2">
                                                    {% if job.transcript_file %}
                                                    <a href="/download/transcript/{{ job.transcript_file }}" 
                                                       onclick="setDefaultAction('{{ job.id }}', 'download', '/download/transcript/{{ job.transcript_file }}', 'Transcript', 'fas fa-file-alt', 'bg-green-600'); toggleJobActions('{{ job.id }}')"
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-file-alt mr-3 text-green-600"></i>Download Transcript
                                                    </a>
                                                    {% endif %}
                                                    
                                                    {% if job.summary_file %}
                                                    <a href="/download/summary/{{ job.summary_file }}" 
                                                       onclick="setDefaultAction('{{ job.id }}', 'download', '/download/summary/{{ job.summary_file }}', 'Summary File', 'fas fa-brain', 'bg-blue-600'); toggleJobActions('{{ job.id }}')"
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-brain mr-3 text-blue-600"></i>Download Summary
                                                    </a>
                                                    {% endif %}
                                                    
                                                    {% if job.speech_file %}
                                                    <button onclick="playInlineAudio('{{ job.id }}', '{{ job.speech_file }}', 'Full Transcript'); setTimeout(() => setDefaultAction('{{ job.id }}', 'play', '{{ job.speech_file }}', 'Full Audio', 'fas fa-play', 'bg-purple-600'), 100); toggleJobActions('{{ job.id }}')" 
                                                            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left">
                                                        <i class="fas fa-play mr-3 text-purple-600"></i>Play Full Audio
                                                    </button>
                                                    <a href="/download/speech/{{ job.speech_file }}" 
                                                       onclick="setDefaultAction('{{ job.id }}', 'download', '/download/speech/{{ job.speech_file }}', 'Full Audio', 'fas fa-download', 'bg-purple-500'); toggleJobActions('{{ job.id }}')"
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-download mr-3 text-purple-500"></i>Download Full Audio
                                                    </a>
                                                    {% endif %}
                                                    
                                                    {% if job.summary_speech_file %}
                                                    <button onclick="playInlineAudio('{{ job.id }}', '{{ job.summary_speech_file }}', 'Summary'); setTimeout(() => setDefaultAction('{{ job.id }}', 'play', '{{ job.summary_speech_file }}', 'Summary', 'fas fa-play', 'bg-indigo-600'), 100); toggleJobActions('{{ job.id }}')" 
                                                            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left">
                                                        <i class="fas fa-play mr-3 text-indigo-600"></i>Play Summary Audio
                                                    </button>
                                                    <a href="/download/summary-speech/{{ job.summary_speech_file }}" 
                                                       onclick="setDefaultAction('{{ job.id }}', 'download', '/download/summary-speech/{{ job.summary_speech_file }}', 'Summary Audio', 'fas fa-download', 'bg-indigo-500'); toggleJobActions('{{ job.id }}')"
                                                       class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i class="fas fa-download mr-3 text-indigo-500"></i>Download Summary Audio
                                                    </a>
                                                    {% endif %}
                                                    
                                                    <!-- Show Summary Text Option -->
                                                    <button onclick="showSummaryText('{{ job.id }}'); setDefaultAction('{{ job.id }}', 'view', '#', 'View Summary', 'fas fa-eye', 'bg-blue-600'); toggleJobActions('{{ job.id }}')" 
                                                            class="flex items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-left">
                                                        <i class="fas fa-eye mr-3 text-blue-600"></i>Show Summary Text
                                                    </button>
                                                    
                                                    <!-- Separator -->
                                                    <div class="border-t border-gray-200 my-2"></div>
                                                    
                                                    <!-- Delete Action -->
                                                    <button onclick="deleteJob('{{ job.id }}'); toggleJobActions('{{ job.id }}')" 
                                                            class="flex items-center w-full px-4 py-2 text-sm text-red-700 hover:bg-red-50 text-left">
                                                        <i class="fas fa-trash mr-3 text-red-600"></i>Delete Job
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% else %}
                                        <!-- For non-completed jobs, just show delete -->
                                        <button onclick="deleteJob('{{ job.id }}')" 
                                                class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition-colors">
                                            <i class="fas fa-trash mr-1"></i>Delete
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-12">
                        <i class="fab fa-youtube text-6xl text-red-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-500 mb-2">No jobs yet</h3>
                        <p class="text-gray-400">Enter a YouTube URL to get started</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Audio Player Modal -->
    <div id="audio-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center h-full p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="audio-title" class="text-lg font-semibold text-gray-800">Audio Player</h3>
                    <button onclick="closeAudioPlayer()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- Audio Element -->
                    <audio id="audio-player" controls class="w-full" controlsList="nodownload">
                        <source id="audio-source" src="" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    
                    <!-- Progress Info -->
                    <div id="audio-info" class="text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span id="current-time">00:00</span>
                            <span id="duration">00:00</span>
                        </div>
                        <div class="mt-1 text-xs text-gray-500">
                            <span id="resume-info"></span>
                        </div>
                    </div>
                    
                    <!-- Control Buttons -->
                    <div class="flex justify-center space-x-4">
                        <button onclick="seekAudio(-10)" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg">
                            <i class="fas fa-backward mr-1"></i>-10s
                        </button>
                        <button id="play-pause-btn" onclick="togglePlayPause()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="seekAudio(10)" class="bg-gray-200 hover:bg-gray-300 px-3 py-2 rounded-lg">
                            <i class="fas fa-forward mr-1"></i>+10s
                        </button>
                    </div>
                    
                    <!-- Speed Control -->
                    <div class="flex items-center justify-center space-x-2">
                        <label for="speed-control" class="text-sm text-gray-600">Speed:</label>
                        <select id="speed-control" onchange="changeSpeed()" class="border border-gray-300 rounded px-2 py-1 text-sm">
                            <option value="0.5">0.5x</option>
                            <option value="0.75">0.75x</option>
                            <option value="1" selected>1x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2">2x</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toast notification system
        function showToast(message, type = 'info', title = null, duration = 5000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation',
                info: 'fas fa-info'
            };
            
            const titles = {
                success: title || 'Success',
                error: title || 'Error',
                warning: title || 'Warning',
                info: title || 'Information'
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">
                        <i class="${icons[type]}"></i>
                    </div>
                    <div class="toast-message">
                        <div class="toast-title">${titles[type]}</div>
                        <div class="toast-description">${message}</div>
                    </div>
                </div>
                <button class="toast-close" onclick="hideToast(this.parentElement)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Auto-hide after duration
            setTimeout(() => {
                hideToast(toast);
            }, duration);
            
            return toast;
        }
        
        function hideToast(toast) {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.parentElement.removeChild(toast);
                }
            }, 300);
        }
        
        // Convenience functions
        function showSuccessToast(message, title = null) {
            return showToast(message, 'success', title);
        }
        
        function showErrorToast(message, title = null) {
            return showToast(message, 'error', title);
        }
        
        function showWarningToast(message, title = null) {
            return showToast(message, 'warning', title);
        }
        
        function showInfoToast(message, title = null) {
            return showToast(message, 'info', title);
        }

        // Global audio player variables
        let currentAudio = null;
        let currentJobId = null;
        let currentAudioType = null;
        let updateTimeInterval = null;

        // File upload handling
        const videoUploadArea = document.getElementById('video-upload-area');
        const videoFileInput = document.getElementById('video-file');
        const videoProgressDiv = document.getElementById('video-upload-progress');
        const videoProgressBar = document.getElementById('video-progress-bar');
        const videoProgressText = document.getElementById('video-progress-text');

        const audioUploadArea = document.getElementById('audio-upload-area');
        const audioFileInput = document.getElementById('audio-file');
        const audioProgressDiv = document.getElementById('audio-upload-progress');
        const audioProgressBar = document.getElementById('audio-progress-bar');
        const audioProgressText = document.getElementById('audio-progress-text');

        // Video upload area handlers
        if (videoUploadArea) {
            videoUploadArea.addEventListener('click', () => videoFileInput.click());
            videoUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                videoUploadArea.classList.add('border-blue-400', 'bg-blue-50');
            });
            videoUploadArea.addEventListener('dragleave', () => {
                videoUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
            });
            videoUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                videoUploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleVideoUpload(files[0]);
                }
            });
        }

        // Audio upload area handlers
        if (audioUploadArea) {
            audioUploadArea.addEventListener('click', () => audioFileInput.click());
            audioUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                audioUploadArea.classList.add('border-green-400', 'bg-green-50');
            });
            audioUploadArea.addEventListener('dragleave', () => {
                audioUploadArea.classList.remove('border-green-400', 'bg-green-50');
            });
            audioUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                audioUploadArea.classList.remove('border-green-400', 'bg-green-50');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleAudioUpload(files[0]);
                }
            });
        }

        if (videoFileInput) {
            videoFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleVideoUpload(e.target.files[0]);
                }
            });
        }

        if (audioFileInput) {
            audioFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleAudioUpload(e.target.files[0]);
                }
            });
        }

        async function handleVideoUpload(file) {
            const summaryPrompt = document.getElementById('video-summary-prompt').value.trim();
            const formData = new FormData();
            formData.append('file', file);
            
            // Only include custom prompt if provided
            if (summaryPrompt) {
                formData.append('custom_prompt', summaryPrompt);
            }

            videoProgressDiv.classList.remove('hidden');
            
            try {
                const response = await axios.post('/api/process-video/', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        'Authorization': `Bearer {{ user.email }}`
                    },
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        videoProgressBar.style.width = percentCompleted + '%';
                        videoProgressText.textContent = percentCompleted + '%';
                    }
                });

                if (response.data.job_id) {
                    if (response.data.duplicate) {
                        showInfoToast(`This video has already been processed! Showing existing results (Job ID: ${response.data.job_id})`, 'Already Processed');
                    } else if (response.data.reused) {
                        showSuccessToast(`ðŸš€ This video was already processed by another user! Created instant copy for you (Job ID: ${response.data.job_id})`, 'Instant Copy Created');
                    } else {
                        showSuccessToast('Video uploaded successfully! Processing started.', 'Upload Complete');
                    }
                    document.getElementById('video-summary-prompt').value = '';
                    setTimeout(refreshJobs, 1000);
                }
            } catch (error) {
                showErrorToast('Upload failed: ' + (error.response?.data?.detail || error.message), 'Upload Failed');
            } finally {
                videoProgressDiv.classList.add('hidden');
                videoProgressBar.style.width = '0%';
                videoProgressText.textContent = '0%';
                videoFileInput.value = '';
            }
        }

        async function handleAudioUpload(file) {
            const summaryPrompt = document.getElementById('audio-summary-prompt').value.trim();
            const formData = new FormData();
            formData.append('file', file);
            
            // Only include custom prompt if provided
            if (summaryPrompt) {
                formData.append('custom_prompt', summaryPrompt);
            }

            audioProgressDiv.classList.remove('hidden');
            
            try {
                const response = await axios.post('/api/process-audio/', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data',
                        'Authorization': `Bearer {{ user.email }}`
                    },
                    onUploadProgress: (progressEvent) => {
                        const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                        audioProgressBar.style.width = percentCompleted + '%';
                        audioProgressText.textContent = percentCompleted + '%';
                    }
                });

                if (response.data.job_id) {
                    if (response.data.duplicate) {
                        showInfoToast(`This audio file has already been processed! Showing existing results (Job ID: ${response.data.job_id})`, 'Already Processed');
                    } else if (response.data.reused) {
                        showSuccessToast(`ðŸš€ This audio file was already processed by another user! Created instant copy for you (Job ID: ${response.data.job_id})`, 'Instant Copy Created');
                    } else {
                        showSuccessToast('Audio uploaded successfully! Processing started.', 'Upload Complete');
                    }
                    document.getElementById('audio-summary-prompt').value = '';
                    setTimeout(refreshJobs, 1000);
                }
            } catch (error) {
                showErrorToast('Upload failed: ' + (error.response?.data?.detail || error.message), 'Upload Failed');
            } finally {
                audioProgressDiv.classList.add('hidden');
                audioProgressBar.style.width = '0%';
                audioProgressText.textContent = '0%';
                audioFileInput.value = '';
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            const videoTab = document.getElementById('video-tab');
            const audioTab = document.getElementById('audio-tab');
            const youtubeTab = document.getElementById('youtube-tab');
            const videoSection = document.getElementById('video-upload-section');
            const audioSection = document.getElementById('audio-upload-section');
            const youtubeSection = document.getElementById('youtube-url-section');

            // Reset all tabs
            [videoTab, audioTab, youtubeTab].forEach(tab => {
                if (tab) {
                    tab.classList.remove('text-blue-600', 'text-green-600', 'text-red-600', 'border-b-2', 'border-blue-600', 'border-green-600', 'border-red-600');
                    tab.classList.add('text-gray-500');
                }
            });

            // Hide all sections
            [videoSection, audioSection, youtubeSection].forEach(section => {
                if (section) section.classList.add('hidden');
            });

            if (tabName === 'video') {
                videoTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                videoTab.classList.remove('text-gray-500');
                videoSection.classList.remove('hidden');
            } else if (tabName === 'audio') {
                audioTab.classList.add('text-green-600', 'border-b-2', 'border-green-600');
                audioTab.classList.remove('text-gray-500');
                audioSection.classList.remove('hidden');
            } else if (tabName === 'youtube') {
                youtubeTab.classList.add('text-red-600', 'border-b-2', 'border-red-600');
                youtubeTab.classList.remove('text-gray-500');
                youtubeSection.classList.remove('hidden');
            }
        }

        // YouTube URL processing
        async function processYouTubeURL() {
            const youtubeInput = document.getElementById('youtube-url').value.trim();
            const summaryPrompt = document.getElementById('youtube-summary-prompt').value.trim();
            const youtubeProgress = document.getElementById('youtube-progress');
            const submitBtn = document.getElementById('youtube-submit-btn');

            if (!youtubeInput) {
                showWarningToast('Please enter a YouTube URL or video ID', 'Missing Input');
                return;
            }

            // Validate YouTube URL format or video ID (11 characters)
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube|youtu|youtube-nocookie)\.(com|be)\/.+/;
            const videoIdRegex = /^[a-zA-Z0-9_-]{11}$/;
            
            if (!youtubeRegex.test(youtubeInput) && !videoIdRegex.test(youtubeInput)) {
                showErrorToast('Please enter a valid YouTube URL or 11-character video ID', 'Invalid Format');
                return;
            }

            youtubeProgress.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            try {
                const requestData = {
                    url: youtubeInput
                };
                
                // Only include custom prompt if provided
                if (summaryPrompt) {
                    requestData.summary_prompt = summaryPrompt;
                }

                const response = await axios.post('/api/process-youtube/', requestData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer {{ user.email }}`
                    }
                });

                if (response.data.job_id) {
                    if (response.data.duplicate) {
                        showInfoToast(`This YouTube video has already been processed! Showing existing results (Job ID: ${response.data.job_id})`, 'Already Processed');
                    } else if (response.data.reused) {
                        showSuccessToast(`ðŸš€ This YouTube video was already processed by another user! Created instant copy for you (Job ID: ${response.data.job_id})`, 'Instant Copy Created');
                    } else {
                        showInfoToast('YouTube video processing started! This may take several minutes.', 'Processing Started');
                    }
                    document.getElementById('youtube-url').value = '';
                    document.getElementById('youtube-summary-prompt').value = '';
                    setTimeout(refreshJobs, 1000);
                }
            } catch (error) {
                showErrorToast('YouTube processing failed: ' + (error.response?.data?.detail || error.message), 'Processing Failed');
            } finally {
                youtubeProgress.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fab fa-youtube mr-2"></i>Process';
            }
        }

        // Allow Enter key to submit YouTube URL
        document.addEventListener('DOMContentLoaded', () => {
            const youtubeInput = document.getElementById('youtube-url');
            if (youtubeInput) {
                youtubeInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        processYouTubeURL();
                    }
                });
            }
        });

        async function refreshJobs() {
            try {
                // Stop all audio before refreshing
                stopAllAudio();
                
                await axios.get('/api/jobs/', {
                    headers: {
                        'Authorization': `Bearer {{ user.email }}`
                    }
                });
                location.reload(); // Simple reload for now
            } catch (error) {
                console.error('Failed to refresh jobs:', error);
            }
        }

        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;
            
            try {
                await axios.delete(`/api/jobs/${jobId}`, {
                    headers: {
                        'Authorization': `Bearer {{ user.email }}`
                    }
                });
                showSuccessToast('Job deleted successfully', 'Job Deleted');
                refreshJobs();
            } catch (error) {
                showErrorToast('Failed to delete job: ' + (error.response?.data?.detail || error.message), 'Deletion Failed');
            }
        }

        // Function to stop all other audio players
        function stopAllAudio() {
            // Stop all inline audio players
            const allAudioElements = document.querySelectorAll('audio[id^="audio-element-"]');
            allAudioElements.forEach(audio => {
                if (!audio.paused) {
                    audio.pause();
                }
            });
            
            // Hide all audio players and show summary text
            const allJobIds = Array.from(allAudioElements).map(audio => {
                const match = audio.id.match(/audio-element-(.+)/);
                return match ? match[1] : null;
            }).filter(Boolean);
            
            allJobIds.forEach(jobId => {
                const contentDiv = document.getElementById(`content-${jobId}`);
                const audioPlayerDiv = document.getElementById(`audio-player-${jobId}`);
                const contentHeader = document.getElementById(`content-header-${jobId}`);
                
                if (contentDiv && audioPlayerDiv && contentHeader) {
                    // Restore the original heading
                    contentHeader.innerHTML = '<i class="fas fa-brain mr-1"></i>AI Summary';
                    
                    // Show summary text and hide audio player
                    audioPlayerDiv.classList.add('hidden');
                    contentDiv.classList.remove('hidden');
                }
            });
            
            // Reset current audio tracking
            currentAudio = null;
            currentJobId = null;
            currentAudioType = null;
        }

        // Inline Audio Player Functions
        function playInlineAudio(jobId, speechFile, audioType = 'Audio') {
            // Stop any currently playing audio first
            stopAllAudio();
            // Stop any currently playing audio first
            stopAllAudio();
            
            // Set the new current audio tracking
            currentJobId = jobId;
            currentAudioType = audioType;
            
            const contentDiv = document.getElementById(`content-${jobId}`);
            const audioPlayerDiv = document.getElementById(`audio-player-${jobId}`);
            const audioElement = document.getElementById(`audio-element-${jobId}`);
            const audioSource = document.getElementById(`audio-source-${jobId}`);
            const audioTitle = document.getElementById(`audio-title-${jobId}`);
            const resumeInfo = document.getElementById(`resume-info-${jobId}`);
            const contentHeader = document.getElementById(`content-header-${jobId}`);

            // Hide summary text and show audio player
            contentDiv.classList.add('hidden');
            audioPlayerDiv.classList.remove('hidden');

            // Update the main heading to show what's playing
            if (audioType === 'Summary') {
                contentHeader.innerHTML = '<i class="fas fa-play mr-1 text-indigo-600"></i>Playing Summary Audio';
                audioSource.src = `/download/summary-speech/${speechFile}`;
                audioTitle.textContent = `Summary Audio`;
            } else if (audioType === 'Full Transcript') {
                contentHeader.innerHTML = '<i class="fas fa-play mr-1 text-purple-600"></i>Playing Full Audio';
                audioSource.src = `/download/speech/${speechFile}`;
                audioTitle.textContent = `Full Audio`;
            } else {
                contentHeader.innerHTML = `<i class="fas fa-play mr-1 text-blue-600"></i>Playing ${audioType}`;
                audioSource.src = `/download/speech/${speechFile}`;
                audioTitle.textContent = audioType;
            }
            
            audioElement.load();
            
            // Set the current audio reference for global tracking
            currentAudio = audioElement;

            // Check for saved position
            const savedTime = localStorage.getItem(`audio_position_${jobId}_${audioType.toLowerCase().replace(' ', '_')}`);
            if (savedTime && parseFloat(savedTime) > 0) {
                const minutes = Math.floor(savedTime / 60);
                const seconds = Math.floor(savedTime % 60);
                resumeInfo.textContent = `Resuming from ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Set the saved time when metadata loads
                audioElement.addEventListener('loadedmetadata', function setTime() {
                    audioElement.currentTime = parseFloat(savedTime);
                    audioElement.removeEventListener('loadedmetadata', setTime);
                }, { once: true });
            } else {
                resumeInfo.textContent = 'Starting from beginning';
            }

            // Setup event listeners for this specific audio element
            setupInlineAudioEventListeners(jobId, audioType);
            
            // Auto-play the audio after setup
            audioElement.play().catch(error => {
                console.log('Auto-play failed, user interaction required:', error);
            });
        }

        function showSummaryText(jobId) {
            // Only stop the current audio if it's from this job
            if (currentJobId === jobId && currentAudio && !currentAudio.paused) {
                currentAudio.pause();
            }
            
            const contentDiv = document.getElementById(`content-${jobId}`);
            const audioPlayerDiv = document.getElementById(`audio-player-${jobId}`);
            const audioElement = document.getElementById(`audio-element-${jobId}`);
            const contentHeader = document.getElementById(`content-header-${jobId}`);

            // Pause audio if playing
            if (!audioElement.paused) {
                audioElement.pause();
            }

            // Restore the original heading
            contentHeader.innerHTML = '<i class="fas fa-brain mr-1"></i>AI Summary';

            // Show summary text and hide audio player
            audioPlayerDiv.classList.add('hidden');
            contentDiv.classList.remove('hidden');
            
            // Clear current audio tracking if this was the active job
            if (currentJobId === jobId) {
                currentAudio = null;
                currentJobId = null;
                currentAudioType = null;
            }
        }

        function setupInlineAudioEventListeners(jobId, audioType) {
            const audioElement = document.getElementById(`audio-element-${jobId}`);
            const currentTimeSpan = document.getElementById(`current-time-${jobId}`);
            const durationSpan = document.getElementById(`duration-${jobId}`);

            // Update duration when metadata loads
            audioElement.addEventListener('loadedmetadata', () => {
                durationSpan.textContent = formatTime(audioElement.duration);
            });

            // Save position periodically and on time update
            audioElement.addEventListener('timeupdate', () => {
                currentTimeSpan.textContent = formatTime(audioElement.currentTime);
                
                // Save position to localStorage every second
                if (audioElement.currentTime > 0) {
                    const storageKey = `audio_position_${jobId}_${audioType.toLowerCase().replace(' ', '_')}`;
                    localStorage.setItem(storageKey, audioElement.currentTime);
                }
            });

            // Clear saved position when audio ends
            audioElement.addEventListener('ended', () => {
                const storageKey = `audio_position_${jobId}_${audioType.toLowerCase().replace(' ', '_')}`;
                localStorage.removeItem(storageKey);
                
                // Clear current audio tracking when audio ends naturally
                if (currentJobId === jobId && currentAudio === audioElement) {
                    currentAudio = null;
                    currentJobId = null;
                    currentAudioType = null;
                }
            });
        }

        function changeSpeed(jobId = null) {
            if (jobId) {
                // Inline audio player
                const audioElement = document.getElementById(`audio-element-${jobId}`);
                const speedControl = document.getElementById(`speed-control-${jobId}`);
                audioElement.playbackRate = parseFloat(speedControl.value);
            } else {
                // Modal audio player
                const audioPlayer = document.getElementById('audio-player');
                const speedControl = document.getElementById('speed-control');
                audioPlayer.playbackRate = parseFloat(speedControl.value);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '00:00';
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function startTimeUpdater() {
            stopTimeUpdater(); // Clear any existing interval
            updateTimeInterval = setInterval(() => {
                const audioPlayer = document.getElementById('audio-player');
                const currentTimeSpan = document.getElementById('current-time');
                if (audioPlayer && !audioPlayer.paused) {
                    currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
                }
            }, 1000);
        }

        function stopTimeUpdater() {
            if (updateTimeInterval) {
                clearInterval(updateTimeInterval);
                updateTimeInterval = null;
            }
        }

        // Close modal when clicking outside
        document.getElementById('audio-modal').addEventListener('click', (e) => {
            if (e.target.id === 'audio-modal') {
                closeAudioPlayer();
            }
        });

        // Keyboard shortcuts for audio player
        document.addEventListener('keydown', (e) => {
            // Only handle shortcuts if we have a currently playing audio
            if (currentAudio && currentJobId) {
                switch(e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (currentAudio.paused) {
                            currentAudio.play();
                        } else {
                            currentAudio.pause();
                        }
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        currentAudio.currentTime = Math.max(0, currentAudio.currentTime - 10);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        currentAudio.currentTime = Math.min(currentAudio.duration, currentAudio.currentTime + 10);
                        break;
                    case 'Escape':
                        e.preventDefault();
                        showSummaryText(currentJobId);
                        break;
                }
            }
        });

        // Cleanup audio when page is about to unload
        window.addEventListener('beforeunload', () => {
            stopAllAudio();
        });

        // Auto-refresh every 30 seconds for processing jobs
        // Smart default action system
        const defaultActions = {}; // Store default actions for each job

        function performDefaultAction(jobId, file, audioType) {
            const action = defaultActions[jobId];
            if (action && action.type === 'play') {
                playInlineAudio(jobId, file, audioType);
            } else if (action && action.type === 'download') {
                window.location.href = action.url;
            } else {
                // Default fallback - play summary audio inline
                playInlineAudio(jobId, file, audioType);
            }
        }

        function setDefaultAction(jobId, actionType, actionUrl, displayName, iconClass, bgColorClass) {
            // Store the new default action
            defaultActions[jobId] = {
                type: actionType,
                url: actionUrl,
                displayName: displayName,
                iconClass: iconClass,
                bgColorClass: bgColorClass
            };

            // Update the button appearance
            updateDefaultButton(jobId, actionType, displayName, iconClass, bgColorClass);
        }

        function updateDefaultButton(jobId, actionType, displayName, iconClass, bgColorClass) {
            const buttonContainer = document.getElementById('default-btn-' + jobId).parentElement;
            const buttonText = document.getElementById('btn-text-' + jobId);
            
            // Update button text
            buttonText.textContent = displayName;
            
            // Get hover color class
            const hoverColorClass = bgColorClass.replace('bg-', 'hover:bg-').replace('-600', '-700').replace('-500', '-600');
            
            // For split button design, update the main button
            if (buttonContainer.classList.contains('flex')) {
                const mainButton = buttonContainer.querySelector('button:first-child');
                const dropdownButton = buttonContainer.querySelector('button:last-child');
                
                // Update main button styling
                mainButton.className = `${bgColorClass} text-white px-4 py-2 rounded-l text-sm ${hoverColorClass} transition-colors flex items-center`;
                
                // Update dropdown button to match
                const borderColorClass = bgColorClass.replace('bg-', 'border-').replace('-600', '-500').replace('-500', '-400');
                dropdownButton.className = `${bgColorClass} text-white px-2 py-2 rounded-r text-sm ${hoverColorClass} transition-colors border-l ${borderColorClass}`;
                
                // Update icon
                const icon = mainButton.querySelector('i');
                icon.className = `${iconClass} mr-2`;
                
                // Update onclick for the main button based on action type
                if (actionType === 'play') {
                    mainButton.setAttribute('onclick', `performDefaultAction('${jobId}', '${defaultActions[jobId].url}', '${displayName}')`);
                } else if (actionType === 'view') {
                    mainButton.setAttribute('onclick', `showSummaryText('${jobId}')`);
                } else {
                    mainButton.setAttribute('onclick', `window.location.href='${defaultActions[jobId].url}'`);
                }
            } else {
                // Single button design
                const button = document.getElementById('default-btn-' + jobId);
                button.className = `${bgColorClass} text-white px-4 py-2 rounded text-sm ${hoverColorClass} transition-colors flex items-center`;
                
                // Update icon
                const icon = button.querySelector('i');
                icon.className = `${iconClass} mr-2`;
            }
        }

        // Toggle dropdown menu for job actions
        function toggleJobActions(jobId) {
            const dropdown = document.getElementById(`actions-${jobId}`);
            const allDropdowns = document.querySelectorAll('[id^="actions-"]');
            
            // Close all other dropdowns
            allDropdowns.forEach(dd => {
                if (dd.id !== `actions-${jobId}`) {
                    dd.classList.add('hidden');
                }
            });
            
            // Toggle current dropdown
            dropdown.classList.toggle('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('[onclick*="toggleJobActions"]') && !e.target.closest('[id^="actions-"]')) {
                const allDropdowns = document.querySelectorAll('[id^="actions-"]');
                allDropdowns.forEach(dd => dd.classList.add('hidden'));
            }
        });

        setInterval(() => {
            const processingJobs = document.querySelectorAll('.fa-spinner');
            if (processingJobs.length > 0) {
                refreshJobs();
            }
        }, 30000);

        // Edit Prompt Modal Functions
        function showEditPromptModal(button) {
            const jobId = button.getAttribute('data-job-id');
            const currentPrompt = button.getAttribute('data-current-prompt');
            
            document.getElementById('edit-job-id').value = jobId;
            document.getElementById('edit-prompt-text').value = currentPrompt;
            document.getElementById('edit-prompt-modal').classList.remove('hidden');
        }

        function closeEditPromptModal() {
            document.getElementById('edit-prompt-modal').classList.add('hidden');
        }

        async function saveEditedPrompt() {
            const jobId = document.getElementById('edit-job-id').value;
            const newPrompt = document.getElementById('edit-prompt-text').value;
            const saveButton = document.querySelector('#edit-prompt-modal button[onclick="saveEditedPrompt()"]');
            const originalText = saveButton.innerHTML;
            
            // Show loading state
            saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Regenerating...';
            saveButton.disabled = true;
            
            try {
                const response = await axios.post('/api/regenerate-summary/', {
                    job_id: jobId,
                    summary_prompt: newPrompt
                }, {
                    headers: {
                        'Authorization': `Bearer {{ user.email }}`
                    }
                });
                
                if (response.data.success) {
                    closeEditPromptModal();
                    
                    // Instead of full page reload, update the specific job card
                    await updateJobCard(jobId);
                    
                    showSuccessToast('Summary regenerated successfully!', 'Summary Updated');
                } else {
                    showErrorToast('Error: ' + response.data.message, 'Update Failed');
                }
            } catch (error) {
                showErrorToast('Error regenerating summary: ' + (error.response?.data?.detail || error.message), 'Update Failed');
            } finally {
                // Restore button state
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }
        }

        // Update a specific job card with fresh data
        async function updateJobCard(jobId) {
            try {
                // Fetch updated job data
                const response = await axios.get(`/api/jobs/${jobId}`, {
                    headers: {
                        'Authorization': `Bearer {{ user.email }}`
                    }
                });
                
                const job = response.data;
                console.log(`ðŸ”„ Updating job card ${jobId} with new summary:`, job.summary?.substring(0, 100) + '...');
                
                // Find the summary content area
                const contentDiv = document.getElementById(`content-${jobId}`);
                if (!contentDiv) {
                    console.error(`Content div not found for job ${jobId}`);
                    return;
                }
                
                const summaryContentDiv = contentDiv.querySelector('.markdown-content');
                if (summaryContentDiv && job.summary) {
                    // Parse markdown-like formatting for basic display
                    const formattedSummary = job.summary
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/\n\n/g, '</p><p>')
                        .replace(/\n/g, '<br>');
                    
                    summaryContentDiv.innerHTML = `<p>${formattedSummary}</p>`;
                    console.log(`âœ… Summary content updated for job ${jobId}`);
                }
                
                // Update the custom prompt display (find the purple prompt box)
                const summarySection = contentDiv.closest('.bg-blue-50');
                if (summarySection) {
                    let customPromptDiv = summarySection.querySelector('.bg-purple-50');
                    
                    if (job.summary_prompt) {
                        // If there's a custom prompt, ensure the prompt box exists and is visible
                        if (!customPromptDiv) {
                            // Create the prompt box if it doesn't exist
                            const promptHTML = `
                                <div class="mb-2 p-2 bg-purple-50 rounded border border-purple-200">
                                    <p class="text-xs text-purple-700 font-medium mb-1">
                                        <i class="fas fa-quote-left mr-1"></i>Custom Prompt Used:
                                    </p>
                                    <p class="text-xs text-purple-600 italic">"${job.summary_prompt}"</p>
                                </div>
                            `;
                            summaryContentDiv.insertAdjacentHTML('beforebegin', promptHTML);
                        } else {
                            // Update existing prompt box
                            const promptText = customPromptDiv.querySelector('.text-purple-600.italic');
                            if (promptText) {
                                promptText.textContent = `"${job.summary_prompt}"`;
                            }
                            customPromptDiv.style.display = 'block';
                        }
                        
                        // Update the header to show custom prompt indicator
                        const headerSpan = summarySection.querySelector('.text-purple-600 span');
                        if (!headerSpan) {
                            const header = summarySection.querySelector('h4');
                            if (header) {
                                header.innerHTML += '<span class="text-xs font-normal text-purple-600 ml-2"><i class="fas fa-magic mr-1"></i>Custom Prompt</span>';
                            }
                        }
                    } else {
                        // No custom prompt, hide the prompt box
                        if (customPromptDiv) {
                            customPromptDiv.style.display = 'none';
                        }
                        
                        // Remove custom prompt indicator from header
                        const headerSpan = summarySection.querySelector('.text-purple-600 span');
                        if (headerSpan) {
                            headerSpan.remove();
                        }
                    }
                }
                
                // Update the edit button's data attribute
                const editButton = document.querySelector(`button[data-job-id="${jobId}"]`);
                if (editButton) {
                    editButton.setAttribute('data-current-prompt', job.summary_prompt || '');
                }
                
                console.log(`âœ… Job card ${jobId} updated successfully`);
                
            } catch (error) {
                console.error(`âŒ Failed to update job card ${jobId}:`, error);
                // Fallback to full page refresh if update fails
                showWarningToast('Content updated, refreshing page...', 'Refreshing');
                setTimeout(() => refreshJobs(), 1000);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('edit-prompt-modal');
            if (e.target === modal) {
                closeEditPromptModal();
            }
        });
    </script>

    <!-- Edit Prompt Modal -->
    <div id="edit-prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-edit mr-2 text-purple-600"></i>Edit Summary Prompt
                </h3>
                <button onclick="closeEditPromptModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label for="edit-prompt-text" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-brain mr-1 text-purple-600"></i>Summary Prompt
                </label>
                <textarea id="edit-prompt-text" 
                          placeholder="Enter a new prompt to regenerate the summary. For example: 'Focus on the technical details and implementation steps.' Leave blank for default summary."
                          rows="4"
                          class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-vertical"></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-lightbulb mr-1"></i>The summary will be regenerated with your new prompt using the existing transcript.
                </p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeEditPromptModal()" 
                        class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    Cancel
                </button>
                <button onclick="saveEditedPrompt()" 
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                    <i class="fas fa-magic mr-2"></i>Regenerate Summary
                </button>
            </div>
            
            <input type="hidden" id="edit-job-id" value="">
        </div>
    </div>
</body>
</html>
