<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Water‑Balance Calculator — Thornthwaite Method</title>
    <style>
      body{font-family:system-ui,sans-serif;padding:1.5rem;}
      table{border-collapse:collapse;width:100%;margin-bottom:1rem;}
      th,td{border:1px solid #d0d0d0;padding:.35rem .5rem;text-align:right;}
      th:first-child,td:first-child{text-align:left;font-weight:600;}
      thead th{background:#f5f5f5;}
      input.numeric{width:4rem;border:none;background:transparent;text-align:right;}
      input.numeric::-webkit-inner-spin-button,input.numeric::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
      input.numeric{-moz-appearance:textfield;}
      .error{background:#ffe5e5;border-bottom:2px solid #e00;}
      .incorrect{background:#ffe5e5;border-bottom:2px solid #e00;}
      .correct{background:#e8ffe8;border-bottom:2px solid #090;}
      .btn{padding:.5rem 1.1rem;font-size:1rem;margin-right:.6rem;cursor:pointer;}
      .config{margin-bottom:.8rem;}
      label{margin-right:.4rem;font-weight:600;}
    </style>
  </head>
  <body>
    <h1>Interactive Water‑Balance Table</h1>

    <div class="config">
      <label for="stStart">Initial soil‑water storage on Dec 31 (mm):</label>
      <input id="stStart" type="number" class="numeric" value="300" style="width:5rem;" />
      <small>(Use 294 for the Hamilton example)</small>
    </div>

    <table id="wbTable">
      <thead>
        <tr>
          <th></th><th>J</th><th>F</th><th>M</th><th>A</th><th>M</th><th>J</th><th>J</th><th>A</th><th>S</th><th>O</th><th>N</th><th>D</th>
        </tr>
      </thead>
      <tbody>
        <tr data-row="PE"><td>PE</td></tr>
        <tr data-row="P"><td>P</td></tr>
        <tr data-row="PPE" class="calc"><td>P‑PE</td></tr>
        <tr data-row="ACC" class="calc"><td>ACC WL</td></tr>
        <tr data-row="ST"  class="calc"><td>ST</td></tr>
        <tr data-row="DST" class="calc"><td>ΔST</td></tr>
        <tr data-row="AE"  class="calc"><td>AE</td></tr>
        <tr data-row="D"   class="calc"><td>D</td></tr>
        <tr data-row="S"   class="calc"><td>S</td></tr>
      </tbody>
    </table>

    <button class="btn" id="solveBtn">Solve</button>
    <button class="btn" id="checkBtn">Check</button>
    <button class="btn" id="resetBtn">Reset</button>

    <script>
      const MONTHS = 12;
      const CAP   = 300;
      const DECAY = 0.00333; // tweaked so ST matches hand‑read Hamilton values
      const tbl   = document.getElementById('wbTable');

      // build editable cells
      tbl.querySelectorAll('tbody tr').forEach(tr=>{
        if(tr.children.length===1){
          for(let i=0;i<MONTHS;i++) tr.insertAdjacentHTML('beforeend','<td><input class="numeric" inputmode="decimal"></td>');
          // add TOTAL column only for PE and P rows
          if(tr.dataset.row==='PE' || tr.dataset.row==='P') tr.insertAdjacentHTML('beforeend','<td class="total"></td>');
        }
      });

      /* helpers */
      const q = sel => tbl.querySelector(sel);
      const cells = r => Array.from(q(`tr[data-row="${r}"]`).querySelectorAll('input.numeric'));
      const get   = r => cells(r).map(e=>parseFloat(e.value));
      const set   = (r,arr)=>cells(r).forEach((el,i)=>el.value=(arr[i]??''));
      const clearCalc = () => ['PPE','ACC','ST','DST','AE','D','S'].forEach(r=>set(r,Array(MONTHS).fill('')));
      const totals = () => ['PE','P'].forEach(r=>{
        const sum = get(r).reduce((a,c)=>a+(Number.isFinite(c)?c:0),0);
        q(`tr[data-row="${r}"] .total`).textContent = sum?sum.toFixed(0):'';
      });
      const flagClear = () => tbl.querySelectorAll('input.numeric').forEach(el=>el.classList.remove('error','incorrect','correct'));

      /* seed Hamilton example */
      const PE0=[0,0,0,30,72,111,135,122,84,48,15,0];
      const P0 =[63,57,66,67,73,63,81,67,61,62,67,64];
      set('PE',PE0); set('P',P0); totals();

      function simulate(ST0){
        const PE=get('PE'); const P=get('P');
        const data={PPE:[],ACC:[],ST:[],DST:[],AE:[],D:[],S:[]};
        let acc=0, stPrev=ST0;
        for(let m=0;m<MONTHS;m++){
          if(Number.isNaN(PE[m])||Number.isNaN(P[m])){Object.keys(data).forEach(k=>data[k].push(''));continue;}
          const ppe=P[m]-PE[m];
          data.PPE.push(ppe);
          acc = ppe<0? acc+Math.abs(ppe) : 0;
          data.ACC.push(acc);

          const st = acc>0 ? CAP*Math.exp(-DECAY*acc) : Math.min(CAP, stPrev + Math.max(ppe,0));
          data.ST.push(st);
          data.DST.push(m? stPrev-st : 0);

          if(acc>0){
            const ae=P[m]+(stPrev-st);
            data.AE.push(ae);
            data.D.push(PE[m]-ae);
            data.S.push(0);
          }else{
            data.AE.push(PE[m]);
            data.D.push(0);
            data.S.push(ppe-(st-stPrev));
          }
          stPrev=st;
        }
        return data;
      }

      function solve(){
        flagClear(); if([...cells('PE'),...cells('P')].some(el=>isNaN(parseFloat(el.value)))){alert('Enter numbers for every PE & P cell');return;}
        const st0=parseFloat(document.getElementById('stStart').value)||CAP;
        const res=simulate(st0);
        Object.entries(res).forEach(([row,arr])=>set(row,arr.map(v=>v===''?'':Math.round(v))));
        totals();
      }

      function check(){
        // clear previous flags
        flagClear();
        const st0=parseFloat(document.getElementById('stStart').value)||CAP;
        const expected = simulate(st0);
        const EPS = 0.5; // tolerance (mm)
        Object.entries(expected).forEach(([row,expArr])=>{
          cells(row).forEach((input,i)=>{
            const userVal = parseFloat(input.value);
            if(isNaN(userVal)) return;        // user left blank => ignore
            const expVal  = expArr[i];
            if(expVal==='') return;           // cannot grade this month yet
            if(Math.abs(userVal - expVal) <= EPS){
              input.classList.add('correct');
            }else{
              input.classList.add('incorrect');
            }
          });
        });
      }

      document.getElementById('solveBtn').onclick=solve;
      document.getElementById('checkBtn').onclick=check;
      document.getElementById('resetBtn').onclick=()=>{set('PE',PE0);set('P',P0);clearCalc();flagClear();document.getElementById('stStart').value=300;totals();};
    </script>
  </body>
</html>
