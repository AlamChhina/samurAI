<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Water‑Balance Calculator</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        padding: 1.5rem;
        line-height: 1.4;
      }
      h1 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        max-width: 100%;
        overflow-x: auto;
      }
      th,
      td {
        border: 1px solid #d0d0d0;
        padding: 0.4rem 0.5rem;
        text-align: right;
      }
      th:first-child,
      td:first-child {
        text-align: left;
        font-weight: 600;
      }
      thead th {
        background: #f4f4f4;
      }
      input[type="number"] {
        width: 4rem;
        border: none;
        background: transparent;
        text-align: right;
      }
      tfoot td {
        font-weight: 700;
        background: #fafafa;
      }
    </style>
  </head>
  <body>
    <h1>Water‑Balance Table (auto‑calculating)</h1>

    <table id="wbTable">
      <thead>
        <tr>
          <th></th>
          <th>J</th><th>F</th><th>M</th><th>A</th><th>M</th><th>J</th><th>J</th><th>A</th><th>S</th><th>O</th><th>N</th><th>D</th>
          <th>TOTAL</th>
        </tr>
      </thead>
      <tbody>
        <!-- Input rows -->
        <tr data-row="PE">
          <td>PE</td>
          <td><input type="number" step="any" value="97" /></td>
          <td><input type="number" step="any" value="80" /></td>
          <td><input type="number" step="any" value="68" /></td>
          <td><input type="number" step="any" value="43" /></td>
          <td><input type="number" step="any" value="27" /></td>
          <td><input type="number" step="any" value="15" /></td>
          <td><input type="number" step="any" value="15" /></td>
          <td><input type="number" step="any" value="19" /></td>
          <td><input type="number" step="any" value="29" /></td>
          <td><input type="number" step="any" value="51" /></td>
          <td><input type="number" step="any" value="64" /></td>
          <td><input type="number" step="any" value="86" /></td>
          <td class="total"></td>
        </tr>
        <tr data-row="P">
          <td>P</td>
          <td><input type="number" step="any" value="30" /></td>
          <td><input type="number" step="any" value="29" /></td>
          <td><input type="number" step="any" value="65" /></td>
          <td><input type="number" step="any" value="87" /></td>
          <td><input type="number" step="any" value="159" /></td>
          <td><input type="number" step="any" value="192" /></td>
          <td><input type="number" step="any" value="164" /></td>
          <td><input type="number" step="any" value="127" /></td>
          <td><input type="number" step="any" value="84" /></td>
          <td><input type="number" step="any" value="36" /></td>
          <td><input type="number" step="any" value="50" /></td>
          <td><input type="number" step="any" value="43" /></td>
          <td class="total"></td>
        </tr>

        <!-- Computed rows (cells will be filled by JS) -->
        <tr data-row="PPE"><td>P‑PE</td><td></td></tr>
        <tr data-row="ACC"><td>ACC WL</td><td></td></tr>
        <tr data-row="ST"><td>ST</td><td></td></tr>
        <tr data-row="DST"><td>ΔST</td><td></td></tr>
        <tr data-row="AE"><td>AE</td><td></td></tr>
        <tr data-row="D"><td>D</td><td></td></tr>
        <tr data-row="S"><td>S</td><td></td></tr>
      </tbody>
    </table>

    <script>
      const MONTHS = 12;
      const CAPACITY = 300; // soil‑water storage capacity
      const DECAY = 0.0034; // Thornthwaite exponent for ST curve

      const table = document.getElementById("wbTable");
      const inputs = table.querySelectorAll("input");
      inputs.forEach((inp) => inp.addEventListener("input", recalc));

      // helper → get numeric array from an input row
      function getRowValues(rowIndex) {
        return Array.from(
          table.querySelectorAll(`tbody tr:nth-child(${rowIndex + 1}) input`)
        ).map((el) => parseFloat(el.value) || 0);
      }

      // helper → write numbers into row cells + total
      function setRowNumbers(rowSelector, values) {
        const row = table.querySelector(rowSelector);
        // ensure 13 cells (1 label + 12 months + total)
        while (row.children.length < 14) {
          const td = document.createElement("td");
          row.appendChild(td);
        }
        let total = 0;
        for (let i = 0; i < MONTHS; i++) {
          row.children[i + 1].textContent = values[i].toFixed(0);
          total += values[i];
        }
        row.children[MONTHS + 1].textContent = total.toFixed(0);
      }

      // update total for input rows
      function updateInputTotals() {
        table.querySelectorAll("tr[data-row='PE'], tr[data-row='P']").forEach((tr) => {
          const nums = Array.from(tr.querySelectorAll("input"), (i) => parseFloat(i.value) || 0);
          tr.querySelector(".total").textContent = nums.reduce((a, c) => a + c, 0).toFixed(0);
        });
      }

      function recalc() {
        // fetch user‑editable arrays
        const PE = getRowValues(0);
        const P = getRowValues(1);

        // 1) P‑PE
        const PPE = P.map((p, i) => p - PE[i]);

        // 2) ACC WL
        const ACC = [];
        let accRun = 0;
        PPE.forEach((val, i) => {
          if (val < 0) {
            accRun += Math.abs(val);
          } else {
            accRun = 0; // reset when water balance turns positive
          }
          ACC[i] = accRun;
        });

        // 3) ST  (soil storage from exponential curve)
        const ST = ACC.map((loss) => (loss === 0 ? CAPACITY : CAPACITY * Math.exp(-DECAY * loss)));

        // 4) ΔST
        const DST = ST.map((_, i) => (i === 0 ? 0 : ST[i - 1] - ST[i]));

        // 5) AE  (actual evapotranspiration)
        const AE = P.map((p, i) => (p >= PE[i] ? PE[i] : Math.min(p + DST[i], PE[i])));

        // 6) D  (deficit)
        const D = PE.map((pe, i) => (P[i] < pe ? pe - AE[i] : 0));

        // 7) S  (surplus – simplified: any P‑PE while soil full)
        const S = Array(MONTHS).fill(0);
        ST.forEach((store, i) => {
          if (store === CAPACITY && PPE[i] > 0) {
            S[i] = PPE[i];
          }
        });

        // push numbers to the table
        setRowNumbers("tr[data-row='PPE']", PPE);
        setRowNumbers("tr[data-row='ACC']", ACC);
        setRowNumbers("tr[data-row='ST']", ST);
        setRowNumbers("tr[data-row='DST']", DST);
        setRowNumbers("tr[data-row='AE']", AE);
        setRowNumbers("tr[data-row='D']", D);
        setRowNumbers("tr[data-row='S']", S);

        updateInputTotals();
      }

      // initial populate
      recalc();
    </script>
  </body>
</html>
